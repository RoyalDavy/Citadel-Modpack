# agot Melee decision by Ronko

namespace = agot_melee

agot_melee.1 = { # start event
	type = character_event
	title = agot_melee.1.t
	desc = agot_melee.1.desc

	theme = feast_activity
	left_portrait = root

	immediate = {
		save_scope_as = host

		capital_province = {
			save_scope_as = host_location
		}

		if = {
			limit = {
				any_courtier_or_guest = {
					is_available_healthy_adult = yes
					NOT = { has_character_flag = attending_melee }
					NOT = { has_character_flag = holding_epic_melee }
					OR = {
						is_landed = yes
						prowess > 8
					}

					NOT = { has_government = theocracy_government }
					NOT = { has_trait = kingsguard }
					NOT = { this = scope:host }

					is_male = yes

					scope:host = {
						NOT = {
							is_target_in_variable_list = {
								name = potential_melee_participants
								target = prev
							}
						}
					}
				}
			}

			every_courtier_or_guest = {
				limit = {
					is_available_healthy_adult = yes
					NOT = { has_character_flag = attending_melee }
					NOT = { has_character_flag = holding_epic_melee }
					OR = {
						is_landed = yes
						prowess > average_skill_rating
					}

					NOT = { has_government = theocracy_government }
					NOT = { has_trait = kingsguard }
					NOT = { this = scope:host }

					is_male = yes

					scope:host = {
						NOT = {
							is_target_in_variable_list = {
								name = potential_melee_participants
								target = prev
							}
						}
					}
				}
				scope:host = {
					add_to_variable_list = {
						name = potential_melee_participants
						target = prev
					}
				}
			}
		}
		if = {
			limit = {
				AND = {
					highest_held_title_tier = tier_duchy
					liege = { highest_held_title_tier = tier_kingdom }
					liege = {
						any_vassal_or_below = {
							is_available_healthy_adult = yes
							NOT = { has_character_flag = attending_melee }
							NOT = { has_character_flag = holding_epic_melee }
							OR = {
								is_landed = yes
								prowess > 8
							}

							NOT = { has_government = theocracy_government }
							NOT = { has_trait = kingsguard }

							is_male = yes

							scope:host = {
								NOT = {
									is_target_in_variable_list = {
										name = potential_melee_participants
										target = prev
									}
								}
							}
						}
					}
				}
			}
			liege = {
				every_vassal_or_below = {
					limit = {
						is_available_healthy_adult = yes
						NOT = { has_character_flag = attending_melee }
						NOT = { has_character_flag = holding_epic_melee }
						OR = {
							is_landed = yes
							prowess > 8
						}

						NOT = { has_government = theocracy_government }
						NOT = { has_trait = kingsguard }

						is_male = yes

						scope:host = {
							NOT = {
								is_target_in_variable_list = {
									name = potential_melee_participants
									target = prev
								}
							}
						}
					}
					scope:host = {
						add_to_variable_list = {
							name = potential_melee_participants
							target = prev
						}
					}
				}
			}
		}
		if = {
			limit = {
				AND = {
					highest_held_title_tier > tier_duchy
					any_vassal_or_below = {
						is_available_healthy_adult = yes
						NOT = { has_character_flag = attending_melee }
						NOT = { has_character_flag = holding_epic_melee }
						OR = {
							is_landed = yes
							prowess > 8
						}

						NOT = { has_government = theocracy_government }
						NOT = { has_trait = kingsguard }

						is_male = yes

						scope:host = {
							NOT = {
								is_target_in_variable_list = {
									name = potential_melee_participants
									target = prev
								}
							}
						}
					}
				}
			}
			every_vassal_or_below = {
				limit = {
					is_available_healthy_adult = yes
					NOT = { has_character_flag = attending_melee }
					NOT = { has_character_flag = holding_epic_melee }
					OR = {
						is_landed = yes
						prowess > average_skill_rating
					}

					NOT = { has_government = theocracy_government }
					NOT = { has_trait = kingsguard }

					is_male = yes

					scope:host = {
						NOT = {
							is_target_in_variable_list = {
								name = potential_melee_participants
								target = prev
							}
						}
					}
				}
				scope:host = {
					add_to_variable_list = {
						name = potential_melee_participants
						target = prev
					}
				}
			}
		}
		if = {
			limit = {
				AND = {
					highest_held_title_tier = tier_duchy
					liege = {
						is_available_healthy_adult = yes
						NOT = { has_character_flag = attending_melee }
						NOT = { has_character_flag = holding_epic_melee }
						OR = {
							is_landed = yes
							prowess > 8
						}

						NOT = { has_government = theocracy_government }
						NOT = { has_trait = kingsguard }

						is_male = yes

						scope:host = {
							NOT = {
								is_target_in_variable_list = {
									name = potential_melee_participants
									target = prev
								}
							}
						}
					}
				}
			}
			liege = {
				scope:host = {
					add_to_variable_list = {
						name = potential_melee_participants
						target = prev
					}
				}
			}
		}
	}
	option = {
		name = agot_melee.1.a

		scope:host = {
			every_in_list = {
				variable = potential_melee_participants
				limit = {
					is_alive = yes
					NOT = { this = scope:host }
					is_at_war = no
					AND = {
						exists = liege
						liege = { is_at_war = no }
					}
					NOT = { has_character_flag = no_melees }
				}
				trigger_event = {
					id = agot_melee.2   #invite possible participants
					days = 1
				}
			}
		}

		ai_chance = {
			base = 100
		}
	}

	option = {
		name = agot_melee.1.b

		scope:host = {
			every_in_list = {
				variable = potential_melee_participants
				limit = {
					is_alive = yes
					NOT = { this = scope:host }
					is_at_war = no
					AND = {
						exists = liege
						liege = { is_at_war = no }
					}
					NOT = { has_character_flag = no_melees }
				}
				trigger_event = {
					id = agot_melee.2   #invite possible participants
					days = 1
				}
			}
			add_character_flag = Only_finale
		}

		ai_chance = {
			base = 0
		}
	}

	after = {
		scope:host = {
			trigger_event = {
				id = agot_melee.3   #Start the melee
				days = 15
			}
		}
	}
}

agot_melee.2 = { #invite possible participants
	type = letter_event
	opening = agot_melee.2.t
	desc = agot_melee.2.desc
	sender = scope:host

	#override_background = {
	#	reference = courtyard
	#}
	#left_portrait = {
	#	character = root
	#	animation = happiness
	#}

	trigger = {
		scope:host = {
			is_at_war = no
			liege = { is_at_war = no }
		}
	}

	option = { #yes
		name = agot_melee.2.a


		scope:host = {
			add_to_variable_list = {
				name = melee_participants
				target = prev
			}
		}
		add_character_flag = attending_melee
		add_prestige = 50

		ai_chance = {
			base = 50

			ai_value_modifier = {
				ai_energy = 0.5
				ai_sociability = 0.5
			}

			modifier = {
				add = 50
				prowess > 15
			}

			modifier = {
				add = 50
				prowess > 20
			}

			modifier = {
				age > 60
				factor = 0.5
			}

			modifier = {
				age > 70
				factor = 0.5
			}
		}
	}

	option = { #no
		name = agot_melee.2.b

		ai_chance = {
			base = 100

			ai_value_modifier = {
				ai_energy = -0.5
				ai_sociability = -0.5
			}

			modifier = {
				add = 300
				scope:host = {
					highest_held_title_tier = tier_empire
				}
			}

			modifier = {
				add = 100
				has_trait = craven
			}

			modifier = {
				add = 100
				has_trait_rank = {
					trait = wounded
					rank > 0
				}
			}

			modifier = {
				add = 200
				AND = {
					prowess <= 10
					scope:host = {
						highest_held_title_tier = tier_empire
					}
				}
			}

			modifier = {
				add = 200
				prowess <= 10
			}

			modifier = {
				add = 200
				AND = {
					has_dynasty = no
					prowess <= 15
				}
			}

			modifier = {
				add = 200
				prowess <= 8
			}

			modifier = {
				add = 300
				AND = {
					is_landed = no
					scope:host = {
						highest_held_title_tier = tier_empire
					}
				}
			}
		}
	}

	option = { #no melees for me
		name = agot_melee.2.c

		add_character_flag = no_melees

		ai_chance = {
			base = 0
		}
	}

}

agot_melee.3 = { #Start the melee
	type = character_event
	title = agot_melee.3.t
	desc = agot_melee.3.desc

	theme = default
	override_background = {
		reference = courtyard
	}
	left_portrait = {
		character = root
		animation = happiness
	}

	trigger = {
		is_at_war = no
		liege = { is_at_war = no }
	}

	option = { # no war, all good, start
		name = agot_melee.3.a
		#trigger = {
		#	is_at_war = no
		#}

		scope:host = {
			every_in_list = {
				variable = melee_participants
				limit = {
					is_alive = yes
					NOT = { this = scope:host }
				}
				trigger_event = {
					id = agot_melee.31   #welcome all participants
				}
			}
		}

		trigger_event = {
			id = agot_melee.4   #check the count of willing participants
			days = 1
		}
		ai_chance = {
			base = 100
		}
	}

	#option = { # war, abort melee
	#	name = agot_melee.3.b
	#	trigger = {
	#		is_at_war = yes
	#	}
	#
	#}

}

agot_melee.31 = { #welcome all participants
	type = character_event
	title = agot_melee.31.t
	desc = agot_melee.31.desc

	theme = default
	override_background = {
		reference = army_camp
	}
	left_portrait = {
		character = root
		animation = happiness
	}

	option = {
		name = agot_melee.31.a

		ai_chance = {
			base = 100
		}
	}
}

agot_melee.4 = { #check the count of willing participants
	type = character_event
	hidden = yes

	immediate = {
		if = {
			limit = {
				scope:host = {
					has_variable_list = melee_participants
					any_in_list = {
						variable = melee_participants
						is_alive = yes
						NOT = { has_character_flag = removed }
						count < 4
					}
				}
			}
			scope:host = {
				every_in_list = {
					variable = melee_participants
					trigger_event = {
						id = agot_melee.5		 #cancel the melee due to lack of participants, Message send to all but the host
					}
				}
			}
			trigger_event = {
				id = agot_melee.52  #cancel the melee due to lack of participants, Message send to the host
				days = 1
			}
		}

		else_if = {
			limit = {
				scope:host = {
					has_variable_list = melee_participants
					any_in_list = {
						variable = melee_participants
						is_alive = yes
						NOT = { has_character_flag = removed }
						count > 16
					}
				}
			}

			scope:host = {
				random_in_list = {
					variable = melee_participants
					limit = {
						is_alive = yes
						NOT = { has_character_flag = removed }
					}
					weight = {
						base = 100
						modifier = {
							factor = { # Prowess directly reduces chance of beeing removed
								value = 40
								subtract = prowess
								divide = 40
								min = 0.1
							}
						}
					}
					trigger_event = {
						id = agot_melee.8	  #randomly remove one participant
					}
				}
			}

			trigger_event = {
				id = agot_melee.4    #reiteration
				days = 1
			}

		}

		else_if = {
			limit = {
				scope:host = {
					has_variable_list = melee_participants
					any_in_list = {
						variable = melee_participants
						is_alive = yes
						NOT = { has_character_flag = removed }
						count <= 16
					}
				}
			}

			trigger_event = {
				id = agot_melee.9	   #proceed the melee
				days = 1
			}
		}
	}
}


agot_melee.5 = { #cancel the melee due to lack of participants, Message send to all but the host
	type = character_event
	title = agot_melee.5.t
	desc = agot_melee.5.desc

	theme = default
	override_background = {
		reference = courtyard
	}
	left_portrait = {
		character = root
		animation = worry
	}

	option = {
		name = agot_melee.5.a
		ai_chance = {
			base = 100
		}
	}
	after = {
		remove_character_flag = attending_melee
		remove_character_flag = removed
		remove_character_flag = lost_melee
		remove_character_flag = OnlyMyFights
		remove_character_flag = fighter1
		remove_character_flag = fighter2
		remove_character_flag = winner
		remove_character_flag = Only_finale
		remove_character_flag = victor
	}
}

agot_melee.52 = { #cancel the melee due to lack of participants, Message send to the host
	type = character_event
	title = agot_melee.52.t
	desc = agot_melee.52.desc

	theme = default
	override_background = {
		reference = courtyard
	}
	left_portrait = {
		character = root
		animation = worry
	}

	trigger = {
		is_at_war = no
		liege = { is_at_war = no }
	}

	option = {
		name = agot_melee.52.a

		add_gold = 75
		add_prestige = -250

		ai_chance = {
			base = 100
		}
	}

	after = {
		scope:host = {
			remove_character_flag = holding_epic_melee
			remove_character_flag = Only_finale
			clear_variable_list = melee_participants
			clear_variable_list = potential_melee_participants
		}
	}
}

agot_melee.53 = { #cancel the melee due to death of host
	type = character_event
	title = agot_melee.53.t
	desc = agot_melee.53.desc

	theme = default
	override_background = {
		reference = courtyard
	}
	left_portrait = {
		character = root
		animation = worry
	}

	option = {
		name = agot_melee.53.a
		ai_chance = {
			base = 100
		}
	}
	after = {
		remove_character_flag = attending_melee
		remove_character_flag = OnlyMyFights
		remove_character_flag = removed
		remove_character_flag = lost_melee
		remove_character_flag = fighter1
		remove_character_flag = fighter2
		remove_character_flag = winner
		remove_character_flag = victor
		remove_character_flag = Only_finale
	}
}

agot_melee.54 = { #cancel the melee due to started war - host
	type = character_event
	title = agot_melee.54.t
	desc = agot_melee.54.desc

	theme = default
	override_background = {
		reference = courtyard
	}
	left_portrait = {
		character = root
		animation = worry
	}

	option = {
		name = agot_melee.54.a

		add_gold = 75
		add_prestige = -250

		ai_chance = {
			base = 100
		}
	}
	after = {
		remove_character_flag = holding_epic_melee
		remove_character_flag = Only_finale
		clear_variable_list = melee_participants
		clear_variable_list = potential_melee_participants
	}
}

agot_melee.55 = { #cancel the melee due to started war - participants
	type = character_event
	title = agot_melee.55.t
	desc = agot_melee.55.desc

	theme = default
	override_background = {
		reference = courtyard
	}
	left_portrait = {
		character = root
		animation = worry
	}

	option = {
		name = agot_melee.55.a
		ai_chance = {
			base = 100
		}
	}
	after = {
		remove_character_flag = attending_melee
		remove_character_flag = removed
		remove_character_flag = lost_melee
		remove_character_flag = OnlyMyFights
		remove_character_flag = fighter1
		remove_character_flag = fighter2
		remove_character_flag = winner
		remove_character_flag = victor
		remove_character_flag = Only_finale
	}
}

agot_melee.8 = { #randomly remove one participant
	type = character_event
	title = agot_melee.8.t
	desc = agot_melee.8.desc

	theme = default
	override_background = {
		reference = army_camp
	}
	left_portrait = {
		character = root
		animation = worry
	}

	option = {
		name = agot_melee.8.a
		add_character_flag = removed
		add_prestige = -50
		ai_chance = {
			base = 0
		}
	}
	option = {
		name = agot_melee.8.b
		add_character_flag = removed
		add_character_flag = OnlyMyFights
		add_prestige = -50
		ai_chance = {
			base = 100
		}
	}
}

agot_melee.9 = { #proceed the melee
	type = character_event
	title = agot_melee.9.t
	desc = agot_melee.9.desc

	theme = default
	override_background = {
		reference = army_camp
	}
	left_portrait = {
		character = root
		animation = happiness
	}

	trigger = {
		is_at_war = no
		liege = { is_at_war = no }
	}

	immediate = {
		scope:host = {
			every_in_list = {
				variable = melee_participants
				limit = {
					is_alive = yes
					NOT = { has_character_flag = removed }
				}
				trigger_event = {
					id = agot_melee.6   #welcome all remaining participants
				}
			}
		}
	}
	option = {
		name = agot_melee.9.a
		ai_chance = {
			base = 100
		}
	}
	after = {
		trigger_event = {
			id = agot_melee.7    #generate the next matchup
			days = 1
		}
	}
}

agot_melee.7 = {	  #generate the next matchup
	type = character_event
	hidden = yes

	trigger = {
		is_at_war = no
		liege = { is_at_war = no }
	}

	immediate = {

		if = {
			limit = {
				scope:host = {
					has_variable_list = melee_participants
					any_in_list = {
						variable = melee_participants
						is_alive = yes
						NOT = { has_character_flag = removed }
						NOT = { has_character_flag = lost_melee }
						NOT = { this = scope:host }
						count > 1
					}
				}
			}
			scope:host = {
				random_in_list = {
					variable = melee_participants
					limit = {
						is_alive = yes
						NOT = { has_character_flag = removed }
						NOT = { has_character_flag = lost_melee }
						NOT = { this = scope:host }
						NOT = { has_character_flag = fighting }
					}
					add_character_flag = fighter1
					save_scope_as = fighter1
				}
			}
			scope:host = {
				random_in_list = {
					variable = melee_participants
					limit = {
						is_alive = yes
						NOT = { has_character_flag = removed }
						NOT = { has_character_flag = lost_melee }
						NOT = { has_character_flag = fighter1 }
						NOT = { this = scope:host }
						NOT = { has_character_flag = fighting }
					}

					add_character_flag = fighter2
					save_scope_as = fighter2
				}
			}

			scope:host = {
				every_in_list = {
					variable = melee_participants
					limit = {
						is_alive = yes
						OR = {
							NOT = { has_character_flag = OnlyMyFights }
							scope:fighter1 = this
							scope:fighter2 = this
						}
					}
					trigger_event = {
						id = agot_melee.10   #inform all participants about the next matchup
					}
				}
			}

			if = {
				limit = {
					has_character_flag = Only_finale
					scope:host = {
						has_variable_list = melee_participants
						any_in_list = {
							variable = melee_participants
							is_alive = yes
							NOT = { has_character_flag = removed }
							NOT = { has_character_flag = lost_melee }
							NOT = { this = scope:host }
							count > 4
						}
					}
				}
				trigger_event = {
					id = agot_melee.1111   #don't inform the host about the next matchup and perform the fight.
					days = 1
				}
			}
			else = {
				trigger_event = {
					id = agot_melee.11   #inform the host about the next matchup and perform the fight.
					days = 1
				}
			}
		}

		else_if = {
			limit = {
				scope:host = {
					has_variable_list = melee_participants
					any_in_list = {
						variable = melee_participants
						is_alive = yes
						NOT = { has_character_flag = removed }
						NOT = { has_character_flag = lost_melee }
						NOT = { this = scope:host }
						count = 1
					}
				}
			}

			scope:host = {
				every_in_list = {
					variable = melee_participants
					limit = {
						NOT = { has_character_flag = removed }
						NOT = { has_character_flag = lost_melee }
						NOT = { this = scope:host }
						is_alive = yes
					}
					add_character_flag = winner
					save_scope_as = winner
				}
			}

			scope:host = {
				every_in_list = {
					variable = melee_participants
					limit = {
						is_alive = yes
						NOT = { has_character_flag = winner }
					}
					trigger_event = {
						id = agot_melee.14   #inform all participantgs but the winner about the winner of the melee
					}
				}
			}

			scope:winner = {
				trigger_event = {
					id = agot_melee.15   #inform the winner and handout prize money + prestige
				}
			}

			trigger_event = {
				id = agot_melee.16   #inform the host about the winner of the melee and finish
				days = 1
			}
		}
	}
}

agot_melee.6 = { #welcome all remaining participants
	type = character_event
	title = agot_melee.6.t
	desc = agot_melee.6.desc

	theme = default
	override_background = {
		reference = army_camp
	}
	left_portrait = {
		character = root
		animation = happiness
	}

	option = {
		name = agot_melee.6.a
		ai_chance = {
			base = 0
		}
	}
	option = {
		name = agot_melee.6.b
		add_character_flag = OnlyMyFights
		ai_chance = {
			base = 100
		}
	}
}

agot_melee.10 = { #inform all participants about the next matchup
	type = character_event
	title = agot_melee.10.t
	desc = agot_melee.10.desc

	theme = physical_health
	override_background = {
		reference = army_camp
	}

	left_portrait = {
		character = scope:fighter1
		animation = war_attacker
	}
	right_portrait = {
		character = scope:fighter2
		animation = war_attacker
	}

	option = {
		name = agot_melee.10.a
		ai_chance = {
			base = 100
		}
	}
}

agot_melee.14 = { #inform all participants but the winner about the winner of the melee
	type = character_event
	title = agot_melee.14.t
	desc = agot_melee.14.desc

	theme = feast_activity
	#override_background = {
	#	reference = army_camp
	#}

	left_portrait = {
		character = scope:winner
		animation = happiness
	}

	option = {
		name = agot_melee.14.a
		remove_character_flag = attending_melee
		remove_character_flag = removed
		remove_character_flag = lost_melee
		remove_character_flag = OnlyMyFights
		remove_character_flag = Only_finale

		ai_chance = {
			base = 100
		}
	}
}

agot_melee.15 = { #inform the winner and handout prize money + prestige
	type = character_event
	title = agot_melee.15.t
	desc = agot_melee.15.desc

	theme = feast_activity
	#override_background = {
	#	reference = army_camp
	#}

	left_portrait = {
		character = scope:winner
		animation = happiness
	}

	option = {
		name = agot_melee.15.a

		create_character_memory = {
			type = agot_melee_winner
			participants = {
				MeleeHost = scope:host
			}
		}

		add_gold = 75
		add_prestige = 250
		add_character_modifier = {
			modifier = Melee_Winner
			years = 5
		}
		remove_character_flag = attending_melee
		remove_character_flag = removed
		remove_character_flag = lost_melee
		remove_character_flag = OnlyMyFights
		remove_character_flag = fighter1
		remove_character_flag = fighter2
		remove_character_flag = Only_finale
		ai_chance = {
			base = 100
		}
	}
	after = {
		remove_character_flag = attending_melee
		remove_character_flag = removed
		remove_character_flag = lost_melee
		remove_character_flag = OnlyMyFights
		remove_character_flag = fighter1
		remove_character_flag = fighter2
		remove_character_flag = Only_finale
	}
}

agot_melee.16 = { #inform the host about the winner of the melee and finish
	type = character_event
	title = agot_melee.16.t
	desc = agot_melee.16.desc

	theme = feast_activity
	#override_background = {
	#	reference = army_camp
	#}

	left_portrait = {
		character = scope:winner
		animation = happiness
	}

	trigger = {
		is_at_war = no
		liege = { is_at_war = no }
	}

	option = {
		name = agot_melee.16.a
		scope:winner = {
			remove_character_flag = winner
		}
		ai_chance = {
			base = 100
		}
	}

	after = {
		scope:host = {
			remove_character_flag = holding_epic_melee
			remove_character_flag = Only_finale
			clear_variable_list = melee_participants
			clear_variable_list = potential_melee_participants
		}
	}
}

agot_melee.11 = { #inform the host about the next matchup and perform the fight.
	type = character_event
	title = agot_melee.11.t
	desc = agot_melee.11.desc

	theme = physical_health
	override_background = {
		reference = army_camp
	}

	left_portrait = {
		character = scope:fighter1
		animation = war_attacker
	}
	right_portrait = {
		character = scope:fighter2
		animation = war_attacker
	}

	trigger = {
		is_at_war = no
		liege = { is_at_war = no }
	}

	immediate = {
		scope:fighter1 = { add_character_flag = fighting }
		scope:fighter2 = { add_character_flag = fighting }
	}

	option = {
		name = agot_melee.11.a

		hidden_effect = {
			configure_start_single_combat_effect = {
				SC_INITIATOR = scope:fighter1
				SC_ATTACKER = scope:fighter1
				SC_DEFENDER = scope:fighter2
				FATALITY = default
				FIXED = no
				LOCALE = terrain_scope
				OUTPUT_EVENT = agot_melee.111
				INVALIDATION_EVENT = single_combat.1006
			}
		}

		ai_chance = {
			base = 100
		}
	}

	after = {
		scope:fighter1 = {
			if = {
				limit = {
					has_character_flag = victor
				}
				save_scope_as = victor
			}
			if = {
				limit = {
					has_character_flag = loser
				}
				save_scope_as = loser
			}
			if = {
				limit = { is_alive = yes }
				remove_character_flag = fighter1
				remove_character_flag = victor
				remove_character_flag = loser
			}
		}

		scope:fighter2 = {
			if = {
				limit = {
					has_character_flag = victor
				}
				save_scope_as = victor
			}
			if = {
				limit = {
					has_character_flag = loser
				}
				save_scope_as = loser
			}
			if = {
				limit = { is_alive = yes }
				remove_character_flag = fighter2
				remove_character_flag = victor
				remove_character_flag = loser
			}
		}

		scope:host = {
			every_in_list = {
				variable = melee_participants
				limit = {
					is_alive = yes
					NOT = { this = scope:host }
					NOT = { has_character_flag = OnlyMyFights }
					NOT = { scope:fighter1 = this }
					NOT = { scope:fighter2 = this }

				}
				trigger_event = {
					id = agot_melee.12   #inform participants about the match result
					days = 1
				}
			}
		}

		trigger_event = {
			id = agot_melee.13   #inform host about the match result
			days = 2
		}
	}
}

agot_melee.1111 = { #don't inform the host about the next matchup and perform the fight.
	type = character_event
	hidden = yes

	trigger = {
		is_at_war = no
		liege = { is_at_war = no }
	}

	immediate = {
		scope:fighter1 = { add_character_flag = fighting }
		scope:fighter2 = { add_character_flag = fighting }

		hidden_effect = {
			configure_start_single_combat_effect = {
				SC_INITIATOR = scope:fighter1
				SC_ATTACKER = scope:fighter1
				SC_DEFENDER = scope:fighter2
				FATALITY = default
				FIXED = no
				LOCALE = terrain_scope
				OUTPUT_EVENT = agot_melee.111
				INVALIDATION_EVENT = single_combat.1006
			}
		}

		scope:fighter1 = {
			if = {
				limit = {
					has_character_flag = victor
				}
				save_scope_as = victor
			}
			if = {
				limit = {
					has_character_flag = loser
				}
				save_scope_as = loser
			}
			if = {
				limit = { is_alive = yes }
				remove_character_flag = fighter1
				remove_character_flag = victor
				remove_character_flag = loser
			}
		}

		scope:fighter2 = {
			if = {
				limit = {
					has_character_flag = victor
				}
				save_scope_as = victor
			}
			if = {
				limit = {
					has_character_flag = loser
				}
				save_scope_as = loser
			}
			if = {
				limit = { is_alive = yes }
				remove_character_flag = fighter2
				remove_character_flag = victor
				remove_character_flag = loser
			}
		}

		scope:host = {
			every_in_list = {
				variable = melee_participants
				limit = {
					is_alive = yes
					NOT = { this = scope:host }
					NOT = { has_character_flag = OnlyMyFights }
					NOT = { scope:fighter1 = this }
					NOT = { scope:fighter2 = this }

				}
				trigger_event = {
					id = agot_melee.12   #inform participants about the match result
					days = 2
				}
			}
		}

		scope:host = {
			trigger_event = {
				id = agot_melee.7   #inform host about the match result
				days = 4
			}
		}
	}
}

agot_melee.111 = {	  #duel outcome event
	hidden = yes

	immediate = {
		scope:sc_victor = {
			#save_scope_as = victor
			add_character_flag = victor
			remove_character_flag = fighting
		}
		scope:sc_loser = {
			if = {
				limit = { is_alive = yes}
				#save_scope_as = loser
				add_character_flag = lost_melee
				add_character_flag = loser
			}
			remove_character_flag = fighting
		}

		#scope:host = {
		#	every_in_list = {
		#		variable = melee_participants
		#		limit = {
		#			is_alive = yes
		#			NOT = { this = scope:host }
		#			OR = {
		#				NOT = { has_character_flag = OnlyMyFights }
		#				scope:fighter1 = this
		#				scope:fighter2 = this
		#			}
		#		}
		#		trigger_event = {
		#			id = agot_melee.12   #inform participants about the match result
		#			days = 1
		#		}
		#	}
		#}

		#scope:host = {
		#	trigger_event = {
		#		id = agot_melee.13   #inform host about the match result
		#		days = 2
		#	}
		#}
	}
}

agot_melee.12 = { #inform participants about the match result
	type = character_event
	title = agot_melee.12.t
	desc = agot_melee.12.desc

	theme = recovery
	override_background = {
		reference = army_camp
	}

	left_portrait = {
		character = scope:victor
		animation = war_over_win
	}
	right_portrait = {
		character = scope:loser
		animation = war_over_loss
	}

	trigger = {
		scope:host = {
			is_at_war = no
			liege = { is_at_war = no }
		}
	}

	option = {
		name = agot_melee.12.a
		ai_chance = {
			base = 100
		}
	}
}

agot_melee.13 = { #inform host about the match result
	type = character_event
	title = agot_melee.13.t
	desc = agot_melee.13.desc

	theme = recovery
	override_background = {
		reference = army_camp
	}

	left_portrait = {
		character = scope:victor
		animation = war_over_win
	}
	right_portrait = {
		character = scope:loser
		animation = war_over_loss
	}

	trigger = {
		is_at_war = no
		liege = { is_at_war = no }
	}

	option = {
		name = agot_melee.13.a
		ai_chance = {
			base = 100
		}
	}

	after = {
		trigger_event = {
			id = agot_melee.7    #reiterate matchups
			days = 1
		}
	}
}