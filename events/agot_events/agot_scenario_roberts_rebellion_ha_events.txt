namespace = agot_scenario_rr_ha

### The Harrenhal Aftermath

## Setup main start ##

# Event for rulers
# Rhaegar asks you to attend to his war council
agot_scenario_rr_ha.0010 = {
	type = letter_event
	opening = agot_scenario_rr_ha.0010.t
	desc = agot_scenario_rr_ha.0010.desc
	sender = scope:ha_initiator
	cooldown = { years = 100 }
	trigger = {
		NOT = {
			has_variable = attending_Targaryen_3s_council
		}
	}

	immediate = {
	}

	### TODO ADD AI WEIGHTS

	option = { # I shall attend; you attend
		name = agot_scenario_rr_ha.0010.a

		character:Targaryen_3 = {
			add_to_variable_list = {
				name = agot_ha_attending_list
				target = prev
			}
		}
		set_variable = attending_Targaryen_3s_council
	}

	option = { # I hate meetings; you do not attend
		name = agot_scenario_rr_ha.0010.b

	}
}

# Event for Rhaegar
# The council meets, Rhaegar chooses to propose rebellion or to stop plotting
agot_scenario_rr_ha.0011 = {
	type = character_event
	title = agot_scenario_rr_ha.0011.t
	desc = agot_scenario_rr_ha.0011.desc

	override_icon = {
		reference = "gfx/interface/icons/event_types/type_war.dds"
	}
	theme = war
	override_background = { reference = throne_room }
	right_portrait = root

	option = { # My father's rule must come to an end
		name = agot_scenario_rr_ha.0011.a
		custom_tooltip = agot_scenario_rr_ha.0011.a.tt
		every_in_list = {
			variable = agot_ha_attending_list

			limit = { NOT = { this = root } }

			trigger_event = agot_scenario_rr_ha.0012
		}
		trigger_event = { id = agot_scenario_rr_ha.0020 days = 1 }

		ai_chance = {
			base = 100
		}
	}

	option = { # This is too scary
		name = agot_scenario_rr_ha.0011.b
		# only during RR
		trigger = {
			character:Targaryen_1 = {
				any_owned_story = {
					story_type = story_agot_mw_crown
				}
			}
		}
		custom_tooltip = agot_scenario_rr_ha.0011.b.tt
		every_in_list = {
			variable = agot_ha_attending_list

			limit = { NOT = { this = root } }

			trigger_event = agot_scenario_rr_ha.0013
		}
		trigger_event = agot_scenario_rr_ha.0015
	}
}

# Event for rulers
# The council meets, Rhaegar proposes his plans
agot_scenario_rr_ha.0012 = {
	type = character_event
	title = agot_scenario_rr_ha.0012.t
	desc = agot_scenario_rr_ha.0012.desc

	override_icon = {
		reference = "gfx/interface/icons/event_types/type_war.dds"
	}
	theme = war
	left_portrait = root
	right_portrait = character:Targaryen_3

	trigger = {
	}

	immediate = {
		character:Targaryen_1 = { trigger_event = agot_scenario_rr_ha.0014 }
	}

	### TODO ADD AI WEIGHTS

	option = { # I will stand with Rhaegar
		name = agot_scenario_rr_ha.0012.a

		character:Targaryen_3 = {
			add_to_variable_list = {
				name = agot_ha_rebel_list
				target = prev
			}
		}

		ai_chance = {
			base = 95
		}
	}

	option = { # I will let fate make my choice! ; you will not choose a side
		name = agot_scenario_rr_ha.0012.b

		character:Targaryen_3 = {
			add_to_variable_list = {
				name = agot_ha_neutral_list #AGOT ERROR - Set but not used
				target = prev
			}
		}

		ai_chance = {
			base = 5
		}
	}

	option = { # This is treason! The king must know!
		name = agot_scenario_rr_ha.0012.c

		character:Targaryen_3 = {
			add_to_variable_list = {
				name = agot_ha_loyalist_list
				target = prev
			}
		}

		ai_chance = {
			base = 0
		}
	}
}

# Event for rulers
# A REAL war council takes place; give some martial bonuses # TODO add modifiers
agot_scenario_rr_ha.0013 = {
	type = character_event
	title = agot_scenario_rr_ha.0013.t
	desc = agot_scenario_rr_ha.0013.desc

	override_icon = {
		reference = "gfx/interface/icons/event_types/type_war.dds"
	}
	theme = war
	left_portrait = root
	right_portrait = character:Targaryen_3

	option = { #
		name = agot_scenario_rr_ha.0013.a
	}
}

# Event for Aerys
# Aerys gets notified about war council taking place # TODO What comes after this?
agot_scenario_rr_ha.0014 = {
	type = character_event
	title = agot_scenario_rr_ha.0014.t
	desc = agot_scenario_rr_ha.0014.desc

	#override_background = {
	#	reference =
	#}
	override_icon = {
		reference = "gfx/interface/icons/event_types/type_war.dds"
	}
	theme = war
	left_portrait = root
	right_portrait = character:Targaryen_3

	option = { #
		name = agot_scenario_rr_ha.0014.a
	}
}

#War Council Rhaegar POV
agot_scenario_rr_ha.0015 = {
	type = character_event
	title = agot_scenario_rr_ha.0015.t
	desc = agot_scenario_rr_ha.0015.desc

	#override_background = {
	#	reference =
	#}
	override_icon = {
		reference = "gfx/interface/icons/event_types/type_war.dds"
	}
	theme = war
	right_portrait = root

	option = { #
		name = agot_scenario_rr_ha.0015.a
	}
}

## Setup main end ##
## Setup outcome start ##

# Event for Rhaegar
# Shows how many attendants support you now; event desc should list all supporters; should end with: "...however, other lords stay silent"
agot_scenario_rr_ha.0020 = {
	type = character_event
	title = agot_scenario_rr_ha.0020.t
	desc = agot_scenario_rr_ha.0020.desc

	override_icon = {
		reference = "gfx/interface/icons/event_types/type_war.dds"
	}
	theme = war
	right_portrait = root

	immediate = {
		if = { # if lords chose to tell the king, well...tell the king
			limit = { has_variable_list = agot_ha_loyalist_list }
			character:Targaryen_1 = { trigger_event = { id = agot_scenario_rr_ha.0021 days = 1 } }
		}
		else = {
			every_in_list = {
				variable = agot_ha_attending_list
				add_character_flag = agot_ha_knows_about_plot
			}
		}
	}

	option = { # Watch them!
		name = agot_scenario_rr_ha.0020.a
		custom_tooltip = agot_scenario_rr_ha.0020.join_rhaegar
		show_as_tooltip = { # TODO Figure out how to show this list as a tooltip.
			every_in_list = {
				variable = agot_ha_rebel_list
				save_scope_as = custom_tooltip_trick
				custom_tooltip = agot_scenario_rr_ha.0020.join_rhaegar_ally
			}
		}

		# start scheme to abduct the king
		# if a lord chose Aerys he will tell him
		start_scheme = { type = abduct target_character = character:Targaryen_1 }
		random_scheme = {
			limit = {
				scheme_type = abduct
			}
			add_scheme_modifier = {
				type = agot_realm_support
			}
		}
		trigger_event = {
			id = agot_scenario_rr_ha.1000
			days = 1
		}
	}
}

# Aerys is told about plot to depose him
# A raven arrived saying Rhaegar is plotting against you!
agot_scenario_rr_ha.0021 = {
	type = character_event
	title = agot_scenario_rr_ha.0021.t
	desc = agot_scenario_rr_ha.0021.desc

	override_icon = {
		reference = "gfx/interface/icons/event_types/type_war.dds"
	}
	theme = war
	right_portrait = root

	option = { # TRAITORS! LET THEM BURN!
		name = agot_scenario_rr_ha.0021.a

		character:Targaryen_3 = {
			random_scheme = {
				limit = {
					scheme_type = abduct
					scheme_target_character = root
				}
				expose_scheme = yes
			}
		}
	}
}

## Setup outcome end ##
## plot outcome start ##
# all events are triggered by agot_scenario_rr_ha.1000

# Event for Rhaegar
# Scheme succeded; King is imprisoned, Rhaegar deposes Aerys
agot_scenario_rr_ha.0030 = {
	type = character_event
	title = agot_scenario_rr_ha.0030.t
	desc = agot_scenario_rr_ha.0030.desc

	#override_background = {
	#	reference =
	#}
	override_icon = {
		reference = "gfx/interface/icons/event_types/type_war.dds"
	}
	theme = war
	right_portrait = root

	trigger = {
	}

	immediate = {
		every_in_list = {
			variable = agot_ha_attending_list
			remove_character_flag = agot_ha_knows_about_plot
		}
		clear_variable_list = agot_ha_attending_list
		clear_variable_list = agot_ha_rebel_list
	}

	option = { # His reign is finally over
		name = agot_scenario_rr_ha.0030.a

		character:Targaryen_1 = { depose = yes }

		#shut up about the Iron Throne being missing
		set_realm_capital = title:c_kings_landing
	}
}

# Event for Rhaegar
# Scheme failed; Notification for Rhaegar
agot_scenario_rr_ha.0031 = {
	type = character_event
	title = agot_scenario_rr_ha.0031.t
	desc = agot_scenario_rr_ha.0031.desc

	override_icon = {
		reference = "gfx/interface/icons/event_types/type_war.dds"
	}
	theme = war
	right_portrait = root

	immediate = {
		every_in_list = {
			variable = agot_ha_attending_list
			limit = { is_alive = yes }
			remove_character_flag = agot_ha_knows_about_plot
		}
		clear_variable_list = agot_ha_attending_list
		clear_variable_list = agot_ha_rebel_list
	}

	option = { # Then war it is
		name = agot_scenario_rr_ha.0031.a


		start_war = {
			casus_belli = depose_war
			target = character:Targaryen_1
		}

		random_scheme = {
			limit = {
				scheme_type = abduct
				scheme_target_character = character:Targaryen_1
			}
			hidden_effect = { end_scheme = yes }
		}
	}
	after = {
		trigger_event = {
			id = agot_scenario_rr_ha.0032
			days = 3
		}
	}
}

agot_scenario_rr_ha.0032 = {
	hidden = yes

	immediate = {
		agot_mw_fetch_crown_story_from_char_scope = { CHECK_CHAR = root }
		agot_mw_fetch_rebel_story_from_char_scope = { CHECK_CHAR = root }

		every_in_list = {
			variable = agot_ha_rebel_list

			save_scope_as = rebeltojoin
			set_variable = { name = mw_is_loyal_to value = root }
			primary_title = { set_variable = { name = chosen_rebel_leader value = root.primary_title } }
			agot_mw_join_rebels_effect = { RULER = scope:rebeltojoin REBEL_LEADER = character:Targaryen_3 }
		}
	}
}

agot_scenario_rr_ha.1000 = {
	hidden = yes

	immediate = {
		if = {
			limit = {
				title:e_the_iron_throne = {
					holder = character:Targaryen_1
				}
				character:Targaryen_1 = {
					is_alive = yes
					is_imprisoned_by = character:Targaryen_3
				}
			}
			character:Targaryen_3 = { trigger_event = agot_scenario_rr_ha.0030 }
		}
		else_if = {
			limit = {
				title:e_the_iron_throne = {
					holder = character:Targaryen_1
				}
				NOT = { is_at_war_with = character:Targaryen_1 }
				any_scheme = {
					scheme_type = abduct
					scheme_target_character = character:Targaryen_1

					is_scheme_exposed = yes
				}
				character:Targaryen_1 = { is_alive = yes }
			}
			character:Targaryen_3 = { trigger_event = agot_scenario_rr_ha.0031 }
		}
		else_if = {
			limit = {
				character:Targaryen_1 = { is_alive = yes }
				title:e_the_iron_throne = {
					holder = character:Targaryen_1
				}
			}
			trigger_event = {
				id = agot_scenario_rr_ha.1000
				days = 1
			}
		}
	}
}

## plot outcome end ##
## TODO We ought to have contingencies for the mega war ending mid-scheme and maybe an event to trigger if Aerys dies of his own accord during the plot.